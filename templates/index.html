{% extends "base.html" %}

{% block title %}Baseball Stats{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-md-8 mx-auto">
            <!-- Welcome Section -->
            <div class="text-center mb-5">
                <h1 class="display-4">Baseball Stats</h1>
                <p class="lead">Explore historical baseball team and player statistics</p>
                <hr class="my-4">

                {% if current_user.is_authenticated %}
                    <p>Welcome back, <strong>{{ current_user.username }}</strong>!</p>
                    <div class="mt-3">
                        {% if current_user.is_admin %}
                            <a class="btn btn-success btn-lg" href="{{ url_for('admin_dashboard') }}" role="button">Admin Dashboard</a>
                        {% endif %}
                    </div>
                {% else %}
                    <p>Please log in or register to access the baseball statistics database.</p>
                    <div class="mt-3">
                        <a class="btn btn-primary btn-lg me-2" href="{{ url_for('login') }}" role="button">Login</a>
                        <a class="btn btn-secondary btn-lg" href="{{ url_for('register') }}" role="button">Register</a>
                    </div>
                {% endif %}
            </div>

            <!-- Posts Section (only visible to logged-in users) -->
            {% if current_user.is_authenticated %}
            <div class="posts-section">
                <!-- Create Post Form -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">What's on your mind?</h5>
                        <form method="POST" action="{{ url_for('create_post') }}">
                            {{ form.hidden_tag() }}
                            <div class="form-group mb-3">
                                {{ form.content(class="form-control", rows="3", placeholder="Share your thoughts...") }}
                                {% if form.content.errors %}
                                    <div class="text-danger mt-2">
                                        {% for error in form.content.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            {{ form.submit(class="btn btn-primary") }}
                        </form>
                    </div>
                </div>

                <!-- Posts Feed -->
                <div class="posts-feed">
                    {% if posts.items %}
                        {% for post in posts.items %}
                        <div class="card mb-3 post-card" data-post-id="{{ post.id }}">
                            <div class="card-body">
                                <!-- Post Header -->
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div>
                                        <h5 class="card-title mb-0">{{ post.author.username }}</h5>
                                        <small class="text-muted">{{ post.created_at.strftime('%B %d, %Y at %I:%M %p') }}</small>
                                    </div>
                                    {% if post.user_id == current_user.id or current_user.is_admin %}
                                    <button class="btn btn-sm btn-outline-danger btn-delete-post" data-post-id="{{ post.id }}">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                    {% endif %}
                                </div>

                                <!-- Post Content -->
                                <p class="card-text mt-3">{{ post.content }}</p>

                                <!-- Post Stats -->
                                <div class="post-stats text-muted mb-3">
                                    <small>
                                        <span class="like-count" data-post-id="{{ post.id }}">{{ post.get_like_count() }}</span>
                                        <span class="like-text">like{{ 's' if post.get_like_count() != 1 else '' }}</span>
                                        &nbsp;&nbsp;&nbsp;
                                        <span class="comment-count" data-post-id="{{ post.id }}">{{ post.get_comment_count() }}</span>
                                        <span class="comment-text">comment{{ 's' if post.get_comment_count() != 1 else '' }}</span>
                                    </small>
                                </div>

                                <!-- Post Actions -->
                                <div class="post-actions mb-3 border-top border-bottom py-2">
                                    {% set user_liked = post.likes | selectattr('user_id', 'equalto', current_user.id) | list | length > 0 %}
                                    <button class="btn btn-sm btn-like" data-post-id="{{ post.id }}" {% if user_liked %}data-liked="true"{% endif %}>
                                        <i class="bi bi-heart{% if user_liked %}-fill{% endif %}"></i>
                                        <span>{% if user_liked %}Liked{% else %}Like{% endif %}</span>
                                    </button>
                                    <button class="btn btn-sm btn-comment" data-post-id="{{ post.id }}">
                                        <i class="bi bi-chat"></i> Comment
                                    </button>
                                </div>

                                <!-- Comments Section -->
                                <div class="comments-section mt-3" id="comments-{{ post.id }}">
                                    {% if post.comments %}
                                    <div class="comments-list">
                                        {% for comment in post.comments | reverse %}
                                        <div class="comment mb-2 pb-2 border-bottom" data-comment-id="{{ comment.id }}">
                                            <div class="d-flex justify-content-between">
                                                <div>
                                                    <strong class="text-primary">{{ comment.author.username }}</strong>
                                                    <small class="text-muted">{{ comment.created_at.strftime('%b %d, %Y at %I:%M %p') }}</small>
                                                </div>
                                                {% if comment.user_id == current_user.id or current_user.is_admin %}
                                                <button class="btn btn-sm btn-outline-danger btn-delete-comment" data-comment-id="{{ comment.id }}">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                                {% endif %}
                                            </div>
                                            <p class="comment-text mt-1 mb-0">{{ comment.content }}</p>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>

                                <!-- Comment Form (hidden by default) -->
                                <div class="comment-form-container mt-3" id="comment-form-{{ post.id }}" style="display: none;">
                                    <div class="card card-body">
                                        <form class="comment-form" data-post-id="{{ post.id }}">
                                            <div class="form-group">
                                                <textarea name="content" class="form-control form-control-sm" rows="2" placeholder="Add a comment..." required></textarea>
                                            </div>
                                            <button type="submit" class="btn btn-sm btn-primary mt-2">Comment</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}

                        <!-- Pagination -->
                        {% if posts.pages > 1 %}
                        <nav aria-label="Page navigation">
                            <ul class="pagination justify-content-center">
                                {% if posts.has_prev %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('index', page=posts.prev_num) }}">Previous</a>
                                </li>
                                {% endif %}

                                {% for page_num in posts.iter_pages() %}
                                    {% if page_num %}
                                        {% if page_num == posts.page %}
                                        <li class="page-item active"><span class="page-link">{{ page_num }}</span></li>
                                        {% else %}
                                        <li class="page-item"><a class="page-link" href="{{ url_for('index', page=page_num) }}">{{ page_num }}</a></li>
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}

                                {% if posts.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('index', page=posts.next_num) }}">Next</a>
                                </li>
                                {% endif %}
                            </ul>
                        </nav>
                        {% endif %}
                    {% else %}
                    <div class="alert alert-info text-center" role="alert">
                        <p>No posts yet. Be the first to post!</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
    .posts-section {
        margin-top: 40px;
    }

    .post-card {
        border: 1px solid #e0e0e0;
        transition: box-shadow 0.3s ease;
    }

    .post-card:hover {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .post-stats {
        font-size: 0.9rem;
    }

    .post-actions .btn {
        color: #555;
        text-decoration: none;
    }

    .post-actions .btn:hover {
        color: #0d6efd;
    }

    .post-actions .btn.liked {
        color: #e74c3c;
    }

    .comment {
        background-color: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
    }

    .comment-text {
        font-size: 0.95rem;
        color: #333;
    }

    .btn-like, .btn-comment {
        color: #555;
    }

    .btn-like:hover {
        color: #e74c3c;
    }

    /* Fix delete button sizes to prevent shape changes */
    .btn-delete-post,
    .btn-delete-comment {
        width: 1.75rem;
        height: .5rem;
        padding: 0.25rem !important;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .btn-delete-post i,
    .btn-delete-comment i {
        font-size: 0.875rem;
    }
</style>

<script>
    // Get CSRF token from the page
    function getCsrfToken() {
        return document.querySelector('input[name="csrf_token"]')?.value || '';
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Toggle comment form visibility
        document.querySelectorAll('.btn-comment').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                const postId = this.getAttribute('data-post-id');
                const formContainer = document.getElementById(`comment-form-${postId}`);
                if (formContainer.style.display === 'none') {
                    formContainer.style.display = 'block';
                    formContainer.querySelector('textarea').focus();
                } else {
                    formContainer.style.display = 'none';
                }
            });
        });

        // Submit comment via AJAX
        document.querySelectorAll('.comment-form').forEach(form => {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                const postId = this.getAttribute('data-post-id');
                const content = this.querySelector('textarea').value;
                const csrfToken = getCsrfToken();

                fetch(`/post/${postId}/comment`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({content: content})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Clear textarea
                        form.querySelector('textarea').value = '';

                        // Add new comment to the page
                        const commentsSection = document.getElementById(`comments-${postId}`);
                        const commentList = commentsSection.querySelector('.comments-list');

                        const newComment = document.createElement('div');
                        newComment.className = 'comment mb-2 pb-2 border-bottom';
                        newComment.setAttribute('data-comment-id', data.comment_id);
                        newComment.innerHTML = `
                            <div class="d-flex justify-content-between">
                                <div>
                                    <strong class="text-primary">${data.username}</strong>
                                    <small class="text-muted">just now</small>
                                </div>
                                <button class="btn btn-sm btn-outline-danger btn-delete-comment" data-comment-id="${data.comment_id}">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                            <p class="comment-text mt-1 mb-0">${content}</p>
                        `;

                        if (commentList) {
                            commentList.insertBefore(newComment, commentList.firstChild);
                        } else {
                            const newList = document.createElement('div');
                            newList.className = 'comments-list';
                            newList.appendChild(newComment);
                            commentsSection.appendChild(newList);
                        }

                        // Update comment count
                        const commentCount = document.querySelector(`.comment-count[data-post-id="${postId}"]`);
                        if (commentCount) {
                            const newCount = parseInt(commentCount.textContent) + 1;
                            commentCount.textContent = newCount;
                            commentCount.nextElementSibling.textContent = `comment${newCount !== 1 ? 's' : ''}`;
                        }

                        // Hide form
                        document.getElementById(`comment-form-${postId}`).style.display = 'none';
                    } else {
                        alert('Error: ' + (data.message || 'Failed to post comment'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while posting the comment');
                });
            });
        });

        // Like/Unlike post
        document.querySelectorAll('.btn-like').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                const postId = this.getAttribute('data-post-id');
                const btn = this;

                fetch(`/post/${postId}/like`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const icon = btn.querySelector('i');
                        const span = btn.querySelector('span');

                        if (data.liked) {
                            icon.classList.remove('bi-heart');
                            icon.classList.add('bi-heart-fill');
                            span.textContent = 'Liked';
                            btn.setAttribute('data-liked', 'true');
                        } else {
                            icon.classList.remove('bi-heart-fill');
                            icon.classList.add('bi-heart');
                            span.textContent = 'Like';
                            btn.removeAttribute('data-liked');
                        }

                        // Update like count
                        const likeCountElem = document.querySelector(`.like-count[data-post-id="${postId}"]`);
                        if (likeCountElem) {
                            likeCountElem.textContent = data.like_count;
                            const likeTextElem = likeCountElem.nextElementSibling;
                            likeTextElem.textContent = `like${data.like_count !== 1 ? 's' : ''}`;
                        }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred');
                });
            });
        });

        // Delete post
        document.querySelectorAll('.btn-delete-post').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                const postId = this.getAttribute('data-post-id');

                if (!confirm('Are you sure you want to delete this post?')) {
                    return;
                }

                fetch(`/post/${postId}/delete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const postCard = document.querySelector(`[data-post-id="${postId}"]`);
                        postCard.style.opacity = '0';
                        setTimeout(() => {
                            postCard.remove();
                        }, 300);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred');
                });
            });
        });

        // Delete comment
        document.addEventListener('click', function(e) {
            if (e.target.closest('.btn-delete-comment')) {
                const btn = e.target.closest('.btn-delete-comment');
                const commentId = btn.getAttribute('data-comment-id');

                if (!confirm('Are you sure you want to delete this comment?')) {
                    return;
                }

                fetch(`/comment/${commentId}/delete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const commentElem = document.querySelector(`[data-comment-id="${commentId}"]`);
                        commentElem.style.opacity = '0';
                        setTimeout(() => {
                            commentElem.remove();
                        }, 300);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred');
                });
            }
        });
    });
</script>
{% endblock %}
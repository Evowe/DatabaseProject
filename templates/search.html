{% extends "base.html" %}

{% block title %}Team Stats Search - Baseball Stats{% endblock %}

{% block content %}
<style>
    /* Make sortable table headers appear clickable */
    #batting th, #pitching th, #fielding th {
        user-select: none;
        white-space: nowrap;
    }

    #batting tbody tr:hover, #pitching tbody tr:hover, #fielding tbody tr:hover {
        background-color: #f9f9f9;
    }

    .player-name {
        color: #333;
        text-decoration: none;
        cursor: pointer;
        transition: color 0.2s ease;
    }

    .player-name:hover {
        color: #0d6efd;
        text-decoration: underline;
    }
</style>
<div class="container mt-5">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <h2>Search Team Statistics</h2>

            <div class="card mt-4">
                <div class="card-body">
                    <form method="POST" novalidate id="searchForm">
                        {{ form.hidden_tag() }}

                        <div class="mb-3">
                            {{ form.team.label(class="form-label") }}
                            <div class="position-relative">
                                {{ form.team(class="form-control" + (" is-invalid" if form.team.errors else ""), id="teamInput", autocomplete="off") }}
                                <div id="teamSuggestions" class="list-group position-absolute w-100" style="max-height: 200px; overflow-y: auto; display: none; z-index: 1000;">
                                </div>
                            </div>
                            {% if form.team.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.team.errors %}
                                    <span>{{ error }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            {{ form.year.label(class="form-label") }}
                            {{ form.year(class="form-control" + (" is-invalid" if form.year.errors else "")) }}
                            {% if form.year.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.year.errors %}
                                    <span>{{ error }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="d-grid">
                            {{ form.submit(class="btn btn-primary") }}
                        </div>
                    </form>
                </div>
            </div>

            {% if error_message %}
            <div class="alert alert-danger alert-dismissible fade show mt-4" role="alert">
                {{ error_message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endif %}

            {% if batting_stats or pitching_stats or fielding_stats %}
            <div class="mt-5">
                <h3>{{ team_name }} - {{ year }}</h3>

                <!-- Nav tabs -->
                <ul class="nav nav-tabs mt-4" id="statsTab" role="tablist">
                    {% if batting_stats %}
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="batting-tab" data-bs-toggle="tab" data-bs-target="#batting" type="button" role="tab" aria-controls="batting" aria-selected="true">
                            Batting Stats
                        </button>
                    </li>
                    {% endif %}
                    {% if pitching_stats %}
                    <li class="nav-item" role="presentation">
                        <button class="nav-link {% if not batting_stats %}active{% endif %}" id="pitching-tab" data-bs-toggle="tab" data-bs-target="#pitching" type="button" role="tab" aria-controls="pitching" aria-selected="{% if not batting_stats %}true{% else %}false{% endif %}">
                            Pitching Stats
                        </button>
                    </li>
                    {% endif %}
                    {% if fielding_stats %}
                    <li class="nav-item" role="presentation">
                        <button class="nav-link {% if not batting_stats and not pitching_stats %}active{% endif %}" id="fielding-tab" data-bs-toggle="tab" data-bs-target="#fielding" type="button" role="tab" aria-controls="fielding" aria-selected="{% if not batting_stats and not pitching_stats %}true{% else %}false{% endif %}">
                            Fielding Stats
                        </button>
                    </li>
                    {% endif %}
                </ul>

                <!-- Tab content -->
                <div class="tab-content" id="statsTabContent">
                    <!-- Batting Stats Tab -->
                    {% if batting_stats %}
                    <div class="tab-pane fade show active" id="batting" role="tabpanel" aria-labelledby="batting-tab">
                        <div class="mt-3 mb-3">
                            <button class="btn btn-sm btn-outline-primary" onclick="exportTableToCSV('Batting', document.getElementById('batting-table'))">
                                Export to CSV
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="batting-table">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Player</th>
                                        <th>G</th>
                                        <th>AB</th>
                                        <th>H</th>
                                        <th>2B</th>
                                        <th>3B</th>
                                        <th>HR</th>
                                        <th>R</th>
                                        <th>RBI</th>
                                        <th>BB</th>
                                        <th>SO</th>
                                        <th>SB</th>
                                        <th>AVG</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for player in batting_stats %}
                                    <tr>
                                        <td>
                                            <a href="{{ url_for('player_detail', player_id=player.player_id) }}" class="player-name">{{ player.first_name }} {{ player.last_name }}</a>
                                            {% if player.is_hall_of_fame %}
                                                <span class="badge bg-warning text-dark" title="Hall of Fame ({{ player.hof_year }})">HOF</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ player.games if player.games else "-" }}</td>
                                        <td>{{ player.at_bats }}</td>
                                        <td>{{ player.hits }}</td>
                                        <td>{{ player.doubles }}</td>
                                        <td>{{ player.triples }}</td>
                                        <td>{{ player.home_runs }}</td>
                                        <td>{{ player.runs }}</td>
                                        <td>{{ player.rbis }}</td>
                                        <td>{{ player.walks }}</td>
                                        <td>{{ player.strikeouts }}</td>
                                        <td>{{ player.stolen_bases }}</td>
                                        <td>{{ "%.3f"|format(player.batting_average) if player.batting_average else "N/A" }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Pitching Stats Tab -->
                    {% if pitching_stats %}
                    <div class="tab-pane fade {% if not batting_stats %}show active{% endif %}" id="pitching" role="tabpanel" aria-labelledby="pitching-tab">
                        <div class="mt-3 mb-3">
                            <button class="btn btn-sm btn-outline-primary" onclick="exportTableToCSV('Pitching', document.getElementById('pitching-table'))">
                                Export to CSV
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="pitching-table">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Player</th>
                                        <th>G</th>
                                        <th>GS</th>
                                        <th>CG</th>
                                        <th>SHO</th>
                                        <th>W</th>
                                        <th>L</th>
                                        <th>SV</th>
                                        <th>IPOuts</th>
                                        <th>H</th>
                                        <th>R</th>
                                        <th>ER</th>
                                        <th>BB</th>
                                        <th>SO</th>
                                        <th>HR</th>
                                        <th>ERA</th>
                                        <th>BAA</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for player in pitching_stats %}
                                    <tr>
                                        <td>
                                            <a href="{{ url_for('player_detail', player_id=player.player_id) }}" class="player-name">{{ player.first_name }} {{ player.last_name }}</a>
                                            {% if player.is_hall_of_fame %}
                                                <span class="badge bg-warning text-dark" title="Hall of Fame ({{ player.hof_year }})">HOF</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ player.games if player.games else "-" }}</td>
                                        <td>{{ player.games_started if player.games_started else "-" }}</td>
                                        <td>{{ player.complete_games if player.complete_games else "-" }}</td>
                                        <td>{{ player.shutouts if player.shutouts else "-" }}</td>
                                        <td>{{ player.wins if player.wins else "-" }}</td>
                                        <td>{{ player.losses if player.losses else "-" }}</td>
                                        <td>{{ player.saves if player.saves else "-" }}</td>
                                        <td>{{ player.ip_outs if player.ip_outs else "-" }}</td>
                                        <td>{{ player.hits if player.hits else "-" }}</td>
                                        <td>{{ player.runs if player.runs else "-" }}</td>
                                        <td>{{ player.earned_runs if player.earned_runs else "-" }}</td>
                                        <td>{{ player.walks if player.walks else "-" }}</td>
                                        <td>{{ player.strikeouts if player.strikeouts else "-" }}</td>
                                        <td>{{ player.home_runs if player.home_runs else "-" }}</td>
                                        <td>{{ player.era if player.era else "N/A" }}</td>
                                        <td>{{ "%.3f"|format(player.batting_avg_allowed) if player.batting_avg_allowed else "N/A" }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Fielding Stats Tab -->
                    {% if fielding_stats %}
                    <div class="tab-pane fade {% if not batting_stats and not pitching_stats %}show active{% endif %}" id="fielding" role="tabpanel" aria-labelledby="fielding-tab">
                        <div class="mt-3 mb-3">
                            <button class="btn btn-sm btn-outline-primary" onclick="exportTableToCSV('Fielding', document.getElementById('fielding-table'))">
                                Export to CSV
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="fielding-table">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Player</th>
                                        <th>Position</th>
                                        <th>G</th>
                                        <th>GS</th>
                                        <th>IO</th>
                                        <th>PO</th>
                                        <th>A</th>
                                        <th>E</th>
                                        <th>DP</th>
                                        <th>PB</th>
                                        <th>PO/G</th>
                                        <th>Fielding Avg</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for player in fielding_stats %}
                                    <tr>
                                        <td>
                                            <a href="{{ url_for('player_detail', player_id=player.player_id) }}" class="player-name">{{ player.first_name }} {{ player.last_name }}</a>
                                            {% if player.is_hall_of_fame %}
                                                <span class="badge bg-warning text-dark" title="Hall of Fame ({{ player.hof_year }})">HOF</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ player.position if player.position else "-" }}</td>
                                        <td>{{ player.games if player.games else "-" }}</td>
                                        <td>{{ player.games_started if player.games_started else "-" }}</td>
                                        <td>{{ player.innings_outs if player.innings_outs else "-" }}</td>
                                        <td>{{ player.putouts if player.putouts else "-" }}</td>
                                        <td>{{ player.assists if player.assists else "-" }}</td>
                                        <td>{{ player.errors if player.errors else "-" }}</td>
                                        <td>{{ player.double_plays if player.double_plays else "-" }}</td>
                                        <td>{{ player.passed_balls if player.passed_balls else "-" }}</td>
                                        <td>{{ player.putouts_per_game if player.putouts_per_game else "-" }}</td>
                                        <td>{{ "%.3f"|format(player.fielding_avg) if player.fielding_avg else "N/A" }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
// Cache for team suggestions to avoid repeated queries
const teamCache = {};
let debounceTimer = null;
const DEBOUNCE_DELAY = 300; // milliseconds
const MIN_CHARS = 2; // minimum characters before searching

// Sort state tracking
const sortState = {
    batting: { column: null, ascending: true },
    pitching: { column: null, ascending: true },
    fielding: { column: null, ascending: true }
};

document.getElementById('teamInput').addEventListener('input', function() {
    const query = this.value.trim();
    const suggestionsDiv = document.getElementById('teamSuggestions');

    // Clear previous timeout
    clearTimeout(debounceTimer);

    if (query.length < MIN_CHARS) {
        suggestionsDiv.style.display = 'none';
        return;
    }

    // Check cache first
    if (teamCache[query]) {
        displaySuggestions(teamCache[query], suggestionsDiv);
        return;
    }

    // Debounce the API call
    debounceTimer = setTimeout(() => {
        fetch(`/api/teams?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                // Cache the result
                teamCache[query] = data.teams;
                displaySuggestions(data.teams, suggestionsDiv);
            })
            .catch(error => console.error('Error:', error));
    }, DEBOUNCE_DELAY);
});

function displaySuggestions(teams, suggestionsDiv) {
    suggestionsDiv.innerHTML = '';

    if (teams.length === 0) {
        suggestionsDiv.style.display = 'none';
        return;
    }

    teams.forEach(team => {
        const button = document.createElement('button');
        button.type = 'button';
        button.className = 'list-group-item list-group-item-action';
        button.textContent = `${team.name} (${team.id})`;
        button.onclick = function(e) {
            e.preventDefault();
            document.getElementById('teamInput').value = team.name;
            suggestionsDiv.style.display = 'none';
        };
        suggestionsDiv.appendChild(button);
    });

    suggestionsDiv.style.display = 'block';
}

// Hide suggestions when clicking outside
document.addEventListener('click', function(e) {
    const suggestionsDiv = document.getElementById('teamSuggestions');
    const teamInput = document.getElementById('teamInput');
    if (e.target !== teamInput && !suggestionsDiv.contains(e.target)) {
        suggestionsDiv.style.display = 'none';
    }
});

// Sortable table functionality
document.addEventListener('DOMContentLoaded', function() {
    // Setup sortable headers for batting table
    const battingHeaders = document.querySelectorAll('#batting th');
    battingHeaders.forEach((header, index) => {
        if (index > 0) { // Skip player name column for default sorting
            header.style.cursor = 'pointer';
            header.addEventListener('click', function() {
                sortTable('batting', index);
            });
        }
    });

    // Setup sortable headers for pitching table
    const pitchingHeaders = document.querySelectorAll('#pitching th');
    pitchingHeaders.forEach((header, index) => {
        if (index > 0) { // Skip player name column for default sorting
            header.style.cursor = 'pointer';
            header.addEventListener('click', function() {
                sortTable('pitching', index);
            });
        }
    });

    // Setup sortable headers for fielding table
    const fieldingHeaders = document.querySelectorAll('#fielding th');
    fieldingHeaders.forEach((header, index) => {
        if (index > 0) { // Skip player name column for default sorting
            header.style.cursor = 'pointer';
            header.addEventListener('click', function() {
                sortTable('fielding', index);
            });
        }
    });
});

function sortTable(tableType, columnIndex) {
    const tableId = tableType;
    const tableBody = document.querySelector(`#${tableId} tbody`);
    const rows = Array.from(tableBody.querySelectorAll('tr'));

    // Get column header text
    const headers = document.querySelectorAll(`#${tableId} th`);
    const columnName = headers[columnIndex].textContent.trim();

    // Toggle sort direction if same column is clicked
    if (sortState[tableType].column === columnIndex) {
        sortState[tableType].ascending = !sortState[tableType].ascending;
    } else {
        sortState[tableType].column = columnIndex;
        sortState[tableType].ascending = true;
    }

    // Sort rows
    rows.sort((a, b) => {
        const aValue = a.cells[columnIndex].textContent.trim();
        const bValue = b.cells[columnIndex].textContent.trim();

        // Try to parse as number
        const aNum = parseFloat(aValue);
        const bNum = parseFloat(bValue);

        let comparison = 0;
        if (!isNaN(aNum) && !isNaN(bNum)) {
            // Numeric sort
            comparison = aNum - bNum;
        } else {
            // String sort
            comparison = aValue.localeCompare(bValue);
        }

        return sortState[tableType].ascending ? comparison : -comparison;
    });

    // Re-render sorted rows
    rows.forEach(row => tableBody.appendChild(row));

    // Update header styling to show sort direction
    updateHeaderStyling(tableType, columnIndex);
}

function updateHeaderStyling(tableType, columnIndex) {
    const headers = document.querySelectorAll(`#${tableType} th`);
    headers.forEach((header, index) => {
        header.textContent = header.textContent.replace(' ▲', '').replace(' ▼', '');
        if (index === columnIndex) {
            const arrow = sortState[tableType].ascending ? ' ▲' : ' ▼';
            header.textContent += arrow;
        }
    });
}

function exportTableToCSV(tableType, tableElement) {
    // Extract headers
    const headers = [];
    tableElement.querySelectorAll('thead th').forEach(th => {
        let headerText = th.textContent.trim();
        // Remove sort arrows
        headerText = headerText.replace(' ▲', '').replace(' ▼', '');
        headers.push(headerText);
    });

    // Extract rows
    const rows = [];
    tableElement.querySelectorAll('tbody tr').forEach(tr => {
        const row = [];
        tr.querySelectorAll('td').forEach(td => {
            let cellText = td.textContent.trim();
            // Remove HOF badge text
            cellText = cellText.replace(/HOF/, '').trim();
            row.push(cellText);
        });
        rows.push(row);
    });

    // Send to Python endpoint
    fetch('/export/csv', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            table_type: tableType,
            team_name: '{{ team_name }}',
            year: '{{ year }}',
            headers: headers,
            rows: rows
        })
    })
    .then(response => response.blob())
    .then(blob => {
        // Create download link
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `{{ team_name }}_{{ year }}_${tableType}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        window.URL.revokeObjectURL(url);
    })
    .catch(error => console.error('Error:', error));
}
</script>

{% endblock %}